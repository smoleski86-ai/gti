<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="GTI">
    <meta name="theme-color" content="#f4f5f7">
    <title>Global Threat Index</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f4f5f7;
            --bg-card: #ffffff;
            --bg-card-hover: #f9fafb;
            --border: #e2e5ea;
            --border-bright: #d0d4db;
            --text: #4a5568;
            --text-bright: #1a202c;
            --text-dim: #9ca3af;
            --red: #dc2626;
            --red-soft: #ef4444;
            --red-dim: rgba(220, 38, 38, 0.08);
            --green: #16a34a;
            --green-bright: #22c55e;
            --green-dim: rgba(22, 163, 74, 0.08);
            --amber: #d97706;
            --amber-dim: rgba(217, 119, 6, 0.08);
            --blue: #2563eb;
            --blue-dim: rgba(37, 99, 235, 0.08);
            --war: #dc2626;
            --resource: #d97706;
            --conflict: #2563eb;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', -apple-system, sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        .header {
            padding: 24px 20px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand { display: flex; align-items: center; gap: 10px; }

        .header-pip {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 6px rgba(22, 163, 74, 0.4);
            animation: pulse-pip 3s ease-in-out infinite;
        }
        .header-pip.stale { background: var(--amber); box-shadow: 0 0 6px rgba(217, 119, 6, 0.4); }
        .header-pip.offline { background: var(--red); box-shadow: 0 0 6px rgba(220, 38, 38, 0.4); }

        @keyframes pulse-pip { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; font-weight: 700;
            letter-spacing: 3.5px; text-transform: uppercase;
            color: var(--text-bright);
        }

        .header-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; color: var(--text-dim); letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ SCALE LEGEND ‚îÄ‚îÄ‚îÄ */
        .scale-legend {
            margin: 0 16px 4px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .scale-legend-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; font-weight: 600;
            letter-spacing: 1.5px; text-transform: uppercase;
            color: var(--text-dim);
            margin-right: 6px;
            flex-shrink: 0;
        }

        .scale-bar {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right,
                var(--green) 0%, var(--green) 30%,
                var(--amber) 30%, var(--amber) 55%,
                var(--red-soft) 55%, var(--red-soft) 75%,
                #b91c1c 75%, #b91c1c 100%
            );
            position: relative;
        }

        .scale-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 0;
            flex: 1;
        }

        .scale-legend-row {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .scale-segment {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .scale-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .scale-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px; font-weight: 600;
            letter-spacing: 0.5px; text-transform: uppercase;
            color: var(--text-dim);
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ‚îÄ TICKER ‚îÄ‚îÄ‚îÄ */
        .ticker-wrap {
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            overflow: hidden; white-space: nowrap;
            background: var(--bg-card);
        }

        .ticker-track {
            display: inline-flex;
            animation: ticker-scroll var(--ticker-duration, 80s) linear infinite;
        }
        .ticker-track:hover { animation-play-state: paused; }

        .ticker-item {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 28px;
            font-family: 'DM Sans', sans-serif; font-size: 11px;
            color: var(--text);
            border-right: 1px solid var(--border);
            flex-shrink: 0; text-decoration: none;
        }

        .ticker-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }

        @keyframes ticker-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        .main-content {
            padding: 20px 16px;
            display: flex; flex-direction: column; gap: 16px;
        }

        /* ‚îÄ‚îÄ‚îÄ METRIC CARDS ‚îÄ‚îÄ‚îÄ */
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .metric-card::before {
            content: ''; position: absolute;
            left: 0; top: 0; bottom: 0; width: 3px;
            border-radius: 12px 0 0 12px;
        }
        .metric-card.war::before { background: var(--war); }
        .metric-card.resources::before { background: var(--resource); }
        .metric-card.conflicts::before { background: var(--conflict); }

        .metric-head {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 14px;
        }

        .metric-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; font-weight: 700;
            letter-spacing: 2.5px; text-transform: uppercase;
            color: var(--text-dim);
            display: flex; align-items: center; gap: 8px;
        }

        .metric-hits {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; color: var(--text-dim); letter-spacing: 0.5px;
        }

        .metric-top-row {
            display: flex; align-items: baseline; gap: 14px;
            margin-bottom: 6px;
        }

        .metric-score-group {
            display: flex; align-items: baseline; gap: 4px;
        }

        .metric-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 46px; font-weight: 800;
            line-height: 1; letter-spacing: -2px;
        }

        .metric-max {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px; font-weight: 600;
            color: var(--text-dim);
            letter-spacing: -0.5px;
        }

        .metric-delta-group {
            display: flex; flex-direction: column; gap: 2px;
        }

        .metric-delta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px; font-weight: 700;
            display: flex; align-items: center; gap: 3px;
            letter-spacing: -0.5px;
        }
        .metric-delta.up { color: var(--red); }
        .metric-delta.down { color: var(--green); }
        .metric-delta.flat { color: var(--text-dim); }

        .metric-direction {
            font-family: 'DM Sans', sans-serif;
            font-size: 9px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1.5px;
        }
        .metric-direction.up { color: var(--red-soft); }
        .metric-direction.down { color: var(--green); }
        .metric-direction.flat { color: var(--text-dim); }

        /* Severity badge */
        .severity-badge {
            display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; font-weight: 700;
            letter-spacing: 2px; text-transform: uppercase;
            padding: 3px 10px;
            border-radius: 4px;
            margin-bottom: 14px;
        }

        .severity-low { background: var(--green-dim); color: var(--green); }
        .severity-elevated { background: var(--amber-dim); color: var(--amber); }
        .severity-high { background: var(--red-dim); color: var(--red-soft); }
        .severity-critical { background: rgba(185, 28, 28, 0.1); color: #b91c1c; }

        .metric-bar-track {
            height: 3px; background: var(--border);
            border-radius: 2px; margin-bottom: 16px; overflow: hidden;
        }
        .metric-bar-fill {
            height: 100%; border-radius: 2px;
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* ‚îÄ‚îÄ‚îÄ SPARKLINE ‚îÄ‚îÄ‚îÄ */
        .sparkline-wrap {
            margin-bottom: 16px;
            position: relative;
            height: 52px;
            border-radius: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .sparkline-label {
            position: absolute;
            top: 4px; left: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px; font-weight: 600;
            letter-spacing: 1px; text-transform: uppercase;
            color: var(--text-dim);
            z-index: 1;
        }

        .sparkline-range {
            position: absolute;
            top: 4px; right: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px; font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            z-index: 1;
        }

        .sparkline-svg {
            width: 100%; height: 100%;
            display: block;
        }

        .sparkline-empty {
            display: flex; align-items: center; justify-content: center;
            height: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; color: var(--text-dim);
            letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADLINES ‚îÄ‚îÄ‚îÄ */
        .headline-list {
            display: flex; flex-direction: column;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .headline-row {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 8px 6px; text-decoration: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s;
            border-radius: 6px;
            margin-left: -6px; margin-right: -6px;
            color: inherit;
        }
        .headline-row:hover { background: var(--bg); }

        .headline-dot {
            width: 5px; height: 5px; border-radius: 50%;
            flex-shrink: 0; margin-top: 7px;
        }

        .headline-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 500;
            line-height: 1.5; color: var(--text-bright);
            white-space: normal; word-break: break-word;
        }
        .headline-row:hover .headline-text { color: var(--blue); }

        .headline-none {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; color: var(--text-dim);
            letter-spacing: 1px; padding: 8px 0;
        }

        /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
        .footer { padding: 16px 20px 32px; text-align: center; }

        .footer-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; color: var(--text-dim);
            letter-spacing: 1px; line-height: 1.8;
        }

        .footer-refresh {
            display: inline-block; margin-top: 12px;
            padding: 8px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
            color: var(--text-dim);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.15s;
        }
        .footer-refresh:active {
            background: var(--bg-card-hover);
            border-color: var(--border-bright);
            color: var(--text-bright);
        }

        .loading-screen {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 70vh; gap: 24px;
        }

        .loading-ring {
            width: 36px; height: 36px;
            border: 2px solid var(--border);
            border-top-color: var(--text);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; color: var(--text-dim);
            letter-spacing: 3px; text-transform: uppercase;
        }

        .error-banner {
            margin: 0 16px 12px; padding: 10px 14px;
            border-radius: 8px;
            background: var(--red-dim);
            border: 1px solid rgba(220, 38, 38, 0.15);
            font-size: 11px; color: var(--red); text-align: center;
        }

        .fade-in { animation: fadeUp 0.5s ease-out both; }
        .fade-in:nth-child(1) { animation-delay: 0.0s; }
        .fade-in:nth-child(2) { animation-delay: 0.08s; }
        .fade-in:nth-child(3) { animation-delay: 0.16s; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-brand">
        <div class="header-pip" id="statusPip"></div>
        <h1>Global Threat Index</h1>
    </div>
    <div class="header-time" id="headerTime"></div>
</div>

<div id="app">
    <div class="loading-screen">
        <div class="loading-ring"></div>
        <div class="loading-label">Scanning Feeds</div>
    </div>
</div>

<script>
const CONFIG = {
    CACHE_KEY: 'gti_cache_v3',
    HISTORY_KEY: 'gti_history_v3',
    TIMESERIES_KEY: 'gti_timeseries_v3',
    CACHE_TTL: 4 * 60 * 60 * 1000,
    TIMESERIES_TTL: 24 * 60 * 60 * 1000,
    EMA_ALPHA: 0.3,
    SCORE_MIDPOINT: 15,
    SCORE_STEEPNESS: 0.15,
    FEEDS: [
        'https://feeds.bbci.co.uk/news/world/rss.xml',
        'https://www.aljazeera.com/xml/rss/all.xml',
        'https://feeds.npr.org/1004/rss.xml'
    ],
    SOURCE_NAMES: ['BBC', 'Al Jazeera', 'NPR']
};

const DICT = {
    war: {
        'military strike': 3, 'air strike': 3, 'airstrike': 3, 'airstrikes': 3,
        'missile launch': 3, 'missile attack': 3, 'ballistic missile': 3,
        'nuclear test': 3, 'nuclear threat': 3, 'nuclear weapon': 3,
        'declare war': 3, 'declaration of war': 3, 'acts of war': 3,
        'ground invasion': 3, 'military invasion': 3,
        'carpet bombing': 3, 'bombing campaign': 3, 'ethnic cleansing': 3,
        'genocide': 3, 'chemical weapon': 3, 'biological weapon': 3,
        'special military operation': 3, 'naval blockade': 3,
        'war crime': 3, 'war crimes': 3, 'crimes against humanity': 3,
        'troops deployed': 2, 'troop deployment': 2, 'military buildup': 2,
        'military operation': 2, 'military offensive': 2, 'ground offensive': 2,
        'artillery fire': 2, 'artillery shell': 2, 'rocket attack': 2,
        'drone strike': 2, 'drone attack': 2, 'suicide bomb': 2,
        'arms shipment': 2, 'weapons delivery': 2, 'military aid': 2,
        'no-fly zone': 2, 'military escalation': 2, 'armed conflict': 2,
        'combat zone': 2, 'frontline': 2, 'front line': 2,
        'civilian casualties': 2, 'civilian deaths': 2, 'mass grave': 2,
        'cluster munition': 2, 'incendiary weapon': 2, 'thermobaric': 2,
        'shelling': 2, 'bombardment': 2, 'besieged': 2,
        'military exercise': 1, 'naval drill': 1, 'military drill': 1,
        'defense spending': 1, 'arms deal': 1, 'weapons sale': 1,
        'military base': 1, 'air defense': 1, 'missile defense': 1,
        'conscription': 1, 'mobilization': 1, 'reservists called': 1,
        'military threat': 1, 'saber rattling': 1, 'show of force': 1,
        'warplane': 1, 'fighter jet': 1, 'aircraft carrier': 1
    },
    resources: {
        'famine': 3, 'mass starvation': 3, 'food crisis': 3,
        'water crisis': 3, 'water shortage': 3, 'drought emergency': 3,
        'energy crisis': 3, 'power crisis': 3, 'oil embargo': 3,
        'crop failure': 3, 'harvest failure': 3, 'food emergency': 3,
        'humanitarian crisis': 3, 'humanitarian disaster': 3,
        'resource war': 3, 'water war': 3, 'famine declared': 3,
        'oil shortage': 2, 'fuel shortage': 2, 'gas shortage': 2,
        'food shortage': 2, 'grain shortage': 2, 'wheat shortage': 2,
        'supply chain crisis': 2, 'supply chain disruption': 2,
        'food insecurity': 2, 'food prices surge': 2, 'food prices soar': 2,
        'oil prices surge': 2, 'energy prices soar': 2, 'commodity spike': 2,
        'power outage': 2, 'blackout': 2, 'rolling blackout': 2,
        'water scarcity': 2, 'aquifer depletion': 2, 'reservoir drought': 2,
        'deforestation': 2, 'illegal logging': 2, 'overfishing': 2,
        'chip shortage': 2, 'semiconductor shortage': 2,
        'fertilizer shortage': 2, 'fertilizer crisis': 2,
        'mining disaster': 2, 'oil spill': 2, 'pipeline explosion': 2,
        'grain export ban': 2, 'food export ban': 2,
        'drought': 1, 'heat wave': 1, 'heatwave': 1, 'wildfire': 1,
        'crop yield': 1, 'food prices': 1, 'oil price': 1,
        'rare earth': 1, 'lithium mining': 1, 'cobalt mining': 1,
        'supply chain': 1, 'export ban': 1, 'import restriction': 1,
        'rationing': 1, 'desertification': 1, 'soil erosion': 1,
        'biodiversity loss': 1, 'fish stocks': 1, 'water table': 1
    },
    conflicts: {
        'coup attempt': 3, "coup d'etat": 3, 'military coup': 3,
        'civil war': 3, 'martial law': 3, 'state of emergency declared': 3,
        'political assassination': 3, 'political violence': 3,
        'ethnic violence': 3, 'sectarian violence': 3,
        'terrorist attack': 3, 'terror attack': 3,
        'border clash': 2, 'border conflict': 2, 'border skirmish': 2,
        'territorial dispute': 2, 'disputed territory': 2,
        'sanctions imposed': 2, 'trade war': 2, 'economic sanctions': 2,
        'diplomatic crisis': 2, 'diplomatic row': 2, 'ambassador recalled': 2,
        'embassy closed': 2, 'embassy stormed': 2, 'embassy attacked': 2,
        'civil unrest': 2, 'mass protest': 2, 'violent protest': 2,
        'violent clashes': 2, 'deadly clashes': 2,
        'riot': 2, 'riots': 2, 'looting': 2,
        'insurgent': 2, 'insurgency': 2, 'rebel attack': 2,
        'militia attack': 2, 'paramilitary': 2, 'separatist': 2,
        'election violence': 2, 'disputed election': 2, 'election fraud': 2,
        'political crisis': 2, 'government collapse': 2, 'regime change': 2,
        'hostage': 2, 'kidnapping': 2, 'hijacking': 2,
        'curfew imposed': 2, 'internet shutdown': 2, 'media blackout': 2,
        'protest': 1, 'protests': 1, 'demonstration': 1, 'demonstrators': 1,
        'sanctions': 1, 'trade dispute': 1, 'tariff': 1, 'tariffs': 1,
        'political tension': 1, 'opposition arrested': 1,
        'press freedom': 1, 'journalist arrested': 1, 'journalist killed': 1,
        'refugee crisis': 1, 'displaced': 1, 'migration crisis': 1,
        'tear gas': 1, 'rubber bullets': 1, 'water cannon': 1,
        'crackdown': 1, 'censorship': 1, 'detain': 1, 'detained': 1
    }
};

const DAMPENERS = [
    'ceasefire','peace deal','peace agreement','peace talks','peace treaty','peace process',
    'de-escalation','deescalation','diplomatic solution','truce','armistice','talks resume',
    'agreement signed','treaty signed','reconciliation','troops withdraw','withdrawal complete',
    'stand down','aid delivered','humanitarian aid arrives','relief effort','reconstruction',
    'rebuilding','recovery effort','relations normalized','diplomatic ties restored',
    'prisoners released','prisoner exchange','hostages freed'
];

const EXCLUSIONS = [
    'movie','film review','book review','album review','box office','trailer release',
    'celebrity','entertainment','red carpet','sports','soccer','football score','basketball',
    'tennis','championship','world cup final','super bowl','grammy','oscar','emmy',
    'tony award','golden globe','tv show','series premiere','season finale','netflix',
    'streaming','video game','gaming','esports','fashion week','recipe','cooking',
    'lifestyle','wellness','horoscope','zodiac','anniversary of','years ago today',
    'obituary for','in memoriam','stock market today','dow jones','nasdaq',
    'cryptocurrency','bitcoin price'
];

const GEO_ENTITIES = [
    'ukraine','russia','china','taiwan','north korea','south korea','iran','israel',
    'palestine','gaza','west bank','lebanon','syria','iraq','afghanistan','yemen',
    'libya','somalia','sudan','south sudan','ethiopia','eritrea','congo','drc',
    'myanmar','kashmir','xinjiang','tibet','hong kong','nato','european union',
    'pentagon','kremlin','south china sea','strait of hormuz','taiwan strait',
    'sahel','horn of africa','middle east','persian gulf','india','pakistan','mexico',
    'venezuela','colombia','nigeria','mozambique','mali','burkina faso','niger',
    'philippines','haiti','hezbollah','hamas','houthi','wagner','islamic state',
    'isis','isil','al qaeda','al-qaeda','red sea','black sea','baltic','arctic',
    'mediterranean'
];

function isExcluded(t) { return EXCLUSIONS.some(e => t.toLowerCase().includes(e)); }
function hasDampener(t) { return DAMPENERS.some(d => t.toLowerCase().includes(d)); }
function hasGeoEntity(t) { return GEO_ENTITIES.some(e => t.toLowerCase().includes(e)); }

function scoreHeadline(title, category) {
    const h = title.toLowerCase();
    let score = 0, matched = false;
    for (const [phrase, weight] of Object.entries(DICT[category])) {
        if (h.includes(phrase)) { score += weight; matched = true; }
    }
    if (!matched) return 0;
    if (hasGeoEntity(title)) score += 1;
    if (hasDampener(title)) score *= 0.3;
    return score;
}

function sigmoid(x, mid, k) { return 100 / (1 + Math.exp(-k * (x - mid))); }

function computeScores(items) {
    const valid = items.filter(it => !isExcluded(it.title));
    const total = valid.length;
    if (total === 0) return null;

    const cats = ['war', 'resources', 'conflicts'];
    const results = {};
    const scored = [];

    for (const cat of cats) {
        let raw = 0, hits = 0;
        for (const item of valid) {
            const s = scoreHeadline(item.title, cat);
            if (s > 0) { hits++; raw += s; scored.push({ title: item.title, link: item.link, category: cat, score: s }); }
        }
        const vf = hits / total;
        const adj = raw * (1 + vf * 3);
        results[cat] = { score: Math.round(sigmoid(adj, CONFIG.SCORE_MIDPOINT, CONFIG.SCORE_STEEPNESS) * 10) / 10, raw, hits };
    }

    const unique = [];
    const seen = new Set();
    scored.sort((a, b) => b.score - a.score);
    for (const s of scored) { if (!seen.has(s.title)) { seen.add(s.title); unique.push(s); } }

    const grouped = { war: [], resources: [], conflicts: [] };
    for (const s of unique) { if (grouped[s.category].length < 6) grouped[s.category].push(s); }

    return { war: results.war, resources: results.resources, conflicts: results.conflicts, total, ticker: unique.slice(0, 24), headlines: grouped, timestamp: Date.now() };
}

// ‚îÄ‚îÄ EMA ‚îÄ‚îÄ
function getHistory() { try { return JSON.parse(localStorage.getItem(CONFIG.HISTORY_KEY)); } catch { return null; } }
function saveHistory(d) { try { localStorage.setItem(CONFIG.HISTORY_KEY, JSON.stringify(d)); } catch {} }

function applyEMA(current, history) {
    const a = CONFIG.EMA_ALPHA, result = { ...current };
    for (const cat of ['war', 'resources', 'conflicts']) {
        if (history && history[cat] && typeof history[cat].ema === 'number') {
            const prev = history[cat].ema;
            const ema = a * current[cat].score + (1 - a) * prev;
            result[cat] = { ...current[cat], ema: Math.round(ema * 10) / 10, delta: Math.round((ema - prev) * 10) / 10, prev };
        } else {
            result[cat] = { ...current[cat], ema: current[cat].score, delta: 0, prev: current[cat].score };
        }
    }
    return result;
}

// ‚îÄ‚îÄ TIME SERIES ‚îÄ‚îÄ
function getTimeSeries() {
    try {
        const arr = JSON.parse(localStorage.getItem(CONFIG.TIMESERIES_KEY)) || [];
        const cutoff = Date.now() - CONFIG.TIMESERIES_TTL;
        return arr.filter(p => p.t > cutoff);
    } catch { return []; }
}

function addTimeSeriesPoint(data) {
    const series = getTimeSeries();
    series.push({
        t: data.timestamp,
        war: data.war.ema,
        resources: data.resources.ema,
        conflicts: data.conflicts.ema
    });
    // Keep max 48 points (generous)
    const trimmed = series.slice(-48);
    try { localStorage.setItem(CONFIG.TIMESERIES_KEY, JSON.stringify(trimmed)); } catch {}
    return trimmed;
}

// ‚îÄ‚îÄ FETCHING ‚îÄ‚îÄ
async function fetchViaRSS2JSON(url) {
    const r = await fetch(`https://api.rss2json.com/api.json?rss_url=${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    if (d.status !== 'ok' || !d.items) throw new Error('bad');
    return d.items.map(i => ({ title: i.title || '', link: i.link || '' })).filter(i => i.title);
}

async function fetchViaAllOrigins(url) {
    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    if (!d.contents) throw new Error('empty');
    return parseItemsFromXML(d.contents);
}

async function fetchViaCorsProxy(url) {
    const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(r.status);
    return parseItemsFromXML(await r.text());
}

async function fetchViaThingProxy(url) {
    const r = await fetch(`https://thingproxy.freeboard.io/fetch/${url}`, { signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(r.status);
    return parseItemsFromXML(await r.text());
}

async function fetchViaCorsSH(url) {
    const r = await fetch(`https://proxy.cors.sh/${url}`, { headers: { 'x-cors-api-key': 'temp_a1b2c3d4e5f6' }, signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(r.status);
    return parseItemsFromXML(await r.text());
}

function parseItemsFromXML(xml) {
    const doc = new DOMParser().parseFromString(xml, 'text/xml');
    const items = Array.from(doc.querySelectorAll('item'));
    if (items.length > 0) {
        return items.map(el => {
            const tEl = el.querySelector('title'), lEl = el.querySelector('link');
            const title = tEl ? tEl.textContent.trim() : '';
            let link = lEl ? lEl.textContent.trim() : '';
            if (!link && lEl && lEl.nextSibling) link = lEl.nextSibling.textContent.trim();
            return { title, link };
        }).filter(i => i.title);
    }
    const results = [];
    for (const b of xml.split(/<item[\s>]/i).slice(1)) {
        const tm = b.match(/<title[^>]*>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/title>/i);
        const lm = b.match(/<link[^>]*>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/link>/i);
        if (tm && tm[1]) results.push({ title: tm[1].trim(), link: (lm && lm[1]) ? lm[1].trim() : '' });
    }
    return results;
}

async function fetchFeed(url) {
    for (const fn of [fetchViaRSS2JSON, fetchViaAllOrigins, fetchViaCorsProxy, fetchViaThingProxy, fetchViaCorsSH]) {
        try { const r = await fn(url); if (r && r.length > 0) return r; } catch {}
    }
    return [];
}

async function fetchAllHeadlines() {
    const results = await Promise.allSettled(CONFIG.FEEDS.map(fetchFeed));
    const items = [], sources = [];
    results.forEach((r, i) => { if (r.status === 'fulfilled' && r.value.length > 0) { items.push(...r.value); sources.push(CONFIG.SOURCE_NAMES[i]); } });
    return { items, sources };
}

function getCache() { try { const d = JSON.parse(localStorage.getItem(CONFIG.CACHE_KEY)); return (d && Date.now() - d.timestamp < CONFIG.CACHE_TTL) ? d : null; } catch { return null; } }
function getStaleCache() { try { return JSON.parse(localStorage.getItem(CONFIG.CACHE_KEY)); } catch { return null; } }
function setCache(d) { try { localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(d)); } catch {} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CAT_META = {
    war:       { label: 'Acts of War',       icon: '‚öî',  color: 'var(--war)',      hex: '#dc2626', hexDim: 'rgba(220,38,38,0.15)' },
    resources: { label: 'Resource Depletion', icon: '‚õΩ', color: 'var(--resource)', hex: '#d97706', hexDim: 'rgba(217,119,6,0.15)' },
    conflicts: { label: 'Conflicts',          icon: '‚ö°', color: 'var(--conflict)', hex: '#2563eb', hexDim: 'rgba(37,99,235,0.15)' }
};

function severityColor(s) {
    if (s < 30) return 'var(--green)';
    if (s < 55) return 'var(--amber)';
    if (s < 75) return 'var(--red)';
    return '#b91c1c';
}

function severityLabel(s) {
    if (s < 30) return { text: 'Low', cls: 'severity-low' };
    if (s < 55) return { text: 'Elevated', cls: 'severity-elevated' };
    if (s < 75) return { text: 'High', cls: 'severity-high' };
    return { text: 'Critical', cls: 'severity-critical' };
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function buildScaleLegend() {
    return `<div class="scale-legend">
        <span class="scale-legend-label">Scale</span>
        <div class="scale-legend-row">
            <div class="scale-segment"><span class="scale-dot" style="background:var(--green)"></span><span class="scale-text">0‚Äì29 Low</span></div>
            <div class="scale-segment"><span class="scale-dot" style="background:var(--amber)"></span><span class="scale-text">30‚Äì54 Elevated</span></div>
            <div class="scale-segment"><span class="scale-dot" style="background:var(--red-soft)"></span><span class="scale-text">55‚Äì74 High</span></div>
            <div class="scale-segment"><span class="scale-dot" style="background:#b91c1c"></span><span class="scale-text">75‚Äì100 Critical</span></div>
        </div>
    </div>`;
}

function buildSparkline(cat, timeSeries) {
    const points = timeSeries.map(p => ({ t: p.t, v: p[cat] })).filter(p => typeof p.v === 'number');

    if (points.length < 2) {
        return `<div class="sparkline-wrap">
            <span class="sparkline-label">24h trend</span>
            <div class="sparkline-empty">Collecting data‚Ä¶</div>
        </div>`;
    }

    const meta = CAT_META[cat];
    const W = 400, H = 52, PAD_TOP = 18, PAD_BOT = 4, PAD_LR = 2;
    const drawW = W - PAD_LR * 2, drawH = H - PAD_TOP - PAD_BOT;

    const vals = points.map(p => p.v);
    let minV = Math.min(...vals), maxV = Math.max(...vals);
    // Ensure some range
    if (maxV - minV < 2) { minV -= 1; maxV += 1; }
    minV = Math.max(0, minV - 2);
    maxV = Math.min(100, maxV + 2);

    const tMin = points[0].t, tMax = points[points.length - 1].t;
    const tRange = tMax - tMin || 1;

    const coords = points.map(p => {
        const x = PAD_LR + ((p.t - tMin) / tRange) * drawW;
        const y = PAD_TOP + drawH - ((p.v - minV) / (maxV - minV)) * drawH;
        return { x, y };
    });

    const linePoints = coords.map(c => `${c.x.toFixed(1)},${c.y.toFixed(1)}`).join(' ');
    const areaPoints = `${coords[0].x.toFixed(1)},${H} ${linePoints} ${coords[coords.length-1].x.toFixed(1)},${H}`;

    // Trend direction for color
    const first = vals[0], last = vals[vals.length - 1];
    const trending = last > first + 0.5 ? 'up' : last < first - 0.5 ? 'down' : 'flat';
    const strokeColor = trending === 'up' ? '#dc2626' : trending === 'down' ? '#16a34a' : '#9ca3af';
    const fillColor = trending === 'up' ? 'rgba(220,38,38,0.08)' : trending === 'down' ? 'rgba(22,163,74,0.08)' : 'rgba(156,163,175,0.06)';

    const rangeText = `${minV.toFixed(0)}‚Äì${maxV.toFixed(0)}`;

    return `<div class="sparkline-wrap">
        <span class="sparkline-label">24h trend</span>
        <span class="sparkline-range">${rangeText}</span>
        <svg class="sparkline-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
            <polygon points="${areaPoints}" fill="${fillColor}" />
            <polyline points="${linePoints}" fill="none" stroke="${strokeColor}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
            <circle cx="${coords[coords.length-1].x.toFixed(1)}" cy="${coords[coords.length-1].y.toFixed(1)}" r="3" fill="${strokeColor}" />
        </svg>
    </div>`;
}

function buildTicker(items) {
    if (!items || !items.length) return '';
    const cm = { war: 'var(--war)', resources: 'var(--resource)', conflicts: 'var(--conflict)' };
    const html = items.map(it => {
        const inner = `<span class="ticker-dot" style="background:${cm[it.category]}"></span>${esc(it.title)}`;
        return it.link
            ? `<a href="${esc(it.link)}" target="_blank" rel="noopener" class="ticker-item">${inner}</a>`
            : `<div class="ticker-item">${inner}</div>`;
    }).join('');
    const speed = Math.max(40, items.length * 4);
    return `<div class="ticker-wrap"><div class="ticker-track" style="--ticker-duration:${speed}s">${html}${html}</div></div>`;
}

function buildHeadlineList(items, color) {
    if (!items || !items.length) return `<div class="headline-list"><div class="headline-none">No matching headlines</div></div>`;
    return `<div class="headline-list">${items.map(it => {
        const tag = it.link ? 'a' : 'div';
        const href = it.link ? ` href="${esc(it.link)}" target="_blank" rel="noopener"` : '';
        return `<${tag}${href} class="headline-row"><span class="headline-dot" style="background:${color}"></span><span class="headline-text">${esc(it.title)}</span></${tag}>`;
    }).join('')}</div>`;
}

function buildMetric(cat, data, headlines, timeSeries) {
    const m = CAT_META[cat];
    const score = data.ema, delta = data.delta;
    const sev = severityLabel(score);

    let dClass = 'flat', arrow = '', dStr = '‚Äî', dirLabel = 'stable';
    if (delta > 0.1) { dClass = 'up'; arrow = '‚ñ≤'; dStr = '+' + delta.toFixed(1); dirLabel = 'rising'; }
    else if (delta < -0.1) { dClass = 'down'; arrow = '‚ñº'; dStr = delta.toFixed(1); dirLabel = 'falling'; }

    return `
    <div class="metric-card ${cat} fade-in">
        <div class="metric-head">
            <div class="metric-label"><span>${m.icon}</span> ${m.label}</div>
            <div class="metric-hits">${data.hits} headlines</div>
        </div>
        <div class="metric-top-row">
            <div class="metric-score-group">
                <div class="metric-score" style="color:${severityColor(score)}">${score.toFixed(1)}</div>
                <div class="metric-max">/100</div>
            </div>
            <div class="metric-delta-group">
                <div class="metric-delta ${dClass}">${arrow} ${dStr}</div>
                <div class="metric-direction ${dClass}">${dirLabel}</div>
            </div>
        </div>
        <div class="severity-badge ${sev.cls}">${sev.text}</div>
        <div class="metric-bar-track">
            <div class="metric-bar-fill" style="width:${Math.min(100, score)}%;background:${severityColor(score)}"></div>
        </div>
        ${buildSparkline(cat, timeSeries)}
        ${buildHeadlineList(headlines, m.color)}
    </div>`;
}

function render(data, sources, timeSeries, stale = false) {
    const app = document.getElementById('app');
    document.getElementById('statusPip').className = 'header-pip' + (stale ? ' stale' : '');
    document.getElementById('headerTime').textContent = new Date(data.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    const srcStr = sources.length ? sources.join(' ¬∑ ') : 'cached';
    const hl = data.headlines || { war: [], resources: [], conflicts: [] };

    app.innerHTML = `
        ${buildTicker(data.ticker)}
        ${stale ? '<div class="error-banner">Feed unavailable ¬∑ showing last cached data</div>' : ''}
        ${buildScaleLegend()}
        <div class="main-content">
            ${buildMetric('war', data.war, hl.war, timeSeries)}
            ${buildMetric('resources', data.resources, hl.resources, timeSeries)}
            ${buildMetric('conflicts', data.conflicts, hl.conflicts, timeSeries)}
        </div>
        <div class="footer">
            <div class="footer-meta">${data.total} headlines analyzed ¬∑ ${srcStr}<br>cache refreshes every 4 hours</div>
            <div class="footer-refresh" id="refreshBtn">‚Üª Force Refresh</div>
        </div>`;
    document.getElementById('refreshBtn').addEventListener('click', () => { localStorage.removeItem(CONFIG.CACHE_KEY); init(); });
}

function renderOffline() {
    document.getElementById('statusPip').className = 'header-pip offline';
    document.getElementById('app').innerHTML = `
    <div class="loading-screen">
        <div style="font-size:32px;margin-bottom:8px">üì°</div>
        <div class="loading-label">No signal</div>
        <div style="font-size:12px;color:var(--text-dim);max-width:260px;text-align:center;line-height:1.6;margin-top:8px">
            Could not reach news feeds and no cached data is available. Check your connection and try again.
        </div>
        <div class="footer-refresh" id="retryBtn" style="margin-top:24px">‚Üª Retry</div>
    </div>`;
    document.getElementById('retryBtn').addEventListener('click', init);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
    document.getElementById('app').innerHTML = `<div class="loading-screen"><div class="loading-ring"></div><div class="loading-label">Scanning Feeds</div></div>`;

    // Try cache
    const cached = getCache();
    if (cached) {
        const ts = getTimeSeries();
        render(cached, cached.sources || [], ts);
        return;
    }

    const { items, sources } = await fetchAllHeadlines();

    if (items.length === 0) {
        const stale = getStaleCache();
        const ts = getTimeSeries();
        if (stale) { render(stale, [], ts, true); }
        else { renderOffline(); }
        return;
    }

    let scores = computeScores(items);
    if (!scores) { renderOffline(); return; }

    scores.sources = sources;
    scores = applyEMA(scores, getHistory());

    setCache(scores);
    saveHistory(scores);
    const ts = addTimeSeriesPoint(scores);
    render(scores, sources, ts);
}

init();
</script>
</body>
</html>
